#==========
# Calibration
#=========

library(dplyr)
library(CalibValidRothC)

set.seed(123)
setwd("/Users/marcospaulopedrosaalves/Documents/Git/AgreenaRothC_data")
# plots_path <- "/Users/marcospaulopedrosaalves/Documents/Git/AgreenaRothC_data/plots"
data_source <- readRDS("/Users/marcospaulopedrosaalves/Documents/Git/AgreenaRothC_data/data_source.rds")

# saveRDS(calib_output, "calib_output.rds")
calib_output <- readRDS("calib_output.rds")

calib_output <- calibration(data_source, stopval = 0.01, maxeval = 100, ub = 1.5, lb = 0.3)

bias_pooled_study <-  calib_output[["all_metrics"]] %>%
  group_by(Publication_ID, Practice_Category, climate_zone, CFGs) %>%
  summarise(mean_bias = mean(bias))

bias_pooled_comb <-  calib_output[["all_metrics"]] %>%
  group_by(Practice_Category, climate_zone, CFGs) %>%
  summarise(mean_bias = mean(bias))

bias_pooled_all <-  calib_output[["all_metrics"]] %>%
  ungroup() %>%
  summarise(mean_bias = mean(bias))

rmse_pooled_study <-  calib_output[["all_metrics"]] %>%
  group_by(Publication_ID, Practice_Category, climate_zone, CFGs) %>%
  summarise(mean_rmse = mean(rmse))

rmse_pooled_comb <-  calib_output[["all_metrics"]] %>%
  group_by(Practice_Category, climate_zone, CFGs) %>%
  summarise(mean_rmse = mean(rmse))

rmse_pooled_all <-  calib_output[["all_metrics"]] %>%
  ungroup() %>%
  summarise(mean_rmse = mean(rmse))

Cis <- conf_int(calib_output[["data_out"]])

plot_validt(Cis, plots_path)

